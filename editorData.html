<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ポケモン会員データ注入</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2em 1em;
      color: #333;
    }
    h1, h2 {
      margin: 0.5em 0;
      text-align: center;
    }
    .card {
      background: white;
      padding: 2em;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
    input[type="file"], button {
      width: 100%;
      padding: 0.8em;
      margin: 1em 0;
      border: none;
      border-radius: 8px;
      font-size: 1em;
    }
    input[type="file"] {
      background: #f0f0f0;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s ease;
    }
    button:hover {
      transform: scale(1.03);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    pre {
      background: #f4f4f4;
      padding: 1em;
      border-radius: 10px;
      width: 100%;
      overflow-x: auto;
      font-size: 0.9em;
    }
    @media (max-width: 600px) {
      .card { padding: 1.2em; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>📁 上传 Excel 并生成 demo.js</h2>
    <input type="file" id="xlsxInput" accept=".xlsx">
    <button id="generateBtn">⬇️ 下载 demo.js</button>
    <pre id="status">等待上传 .xlsx 文件…</pre>
  </div>

  <script>
    let globalUserData = [];

    function addressChange(address) {
      const toFullWidthNumber = num => num.replace(/[0-9]/g, d => String.fromCharCode(d.charCodeAt(0) + 0xFF10 - 0x30));
      const toKanjiNumber = num => {
        const kanjiDigits = ['〇','一','二','三','四','五','六','七','八','九'];
        const n = parseInt(num, 10);
        if (isNaN(n)) return num;
        if (n <= 10) return kanjiDigits[n];
        return num.split('').map(d => kanjiDigits[+d]).join('');
      };
      const [chome, ban, go] = address.split(/[-ー−]/);
      if ([chome, ban, go].includes(undefined)) return address;
      const chomeVariants = [ chome+"丁目", toFullWidthNumber(chome)+"ちょうめ", toFullWidthNumber(chome)+"チョウメ", toKanjiNumber(chome)+"丁目" ];
      const banVariants = [ ban+"番", toFullWidthNumber(ban)+"ばん", toFullWidthNumber(ban)+"バン", toKanjiNumber(ban)+"番" ];
      const goVariants = [ go+"号", toFullWidthNumber(go)+"ごう", toFullWidthNumber(go)+"ゴウ", toKanjiNumber(go)+"号" ];
      while (true) {
        const chomeStr = chomeVariants[Math.random() * chomeVariants.length | 0];
        const banStr = banVariants[Math.random() * banVariants.length | 0];
        const goStr = goVariants[Math.random() * goVariants.length | 0];
        const useDash1 = Math.random() < 0.5;
        const useDash2 = Math.random() < 0.5;
        if (useDash1 && banStr === "一番") continue;
        if (useDash2 && goStr === "一号") continue;
        return chomeStr + (useDash1 ? '-' : '') + banStr + (useDash2 ? '-' : '') + goStr;
      }
    }

    function generateRandomPhone() {
      const prefix = ['070', '080', '090'][Math.floor(Math.random() * 3)];
      let phone = prefix;
      for (let i = 0; i < 8; i++) {
        phone += Math.floor(Math.random() * 10);
      }
      return phone;
    }

    function generateRandomString(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
      return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    function parseXLSX(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          const workbook = XLSX.read(e.target.result, { type: 'binary' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);
          if (!json[0] || !json[0].email || !json[0].rowpassword) {
            alert('❌ 表格缺少必要字段 (email, rowpassword 等)，请检查 Excel');
            reject('invalid header');
            return;
          }
          const data = json.map(r => ({
            email: r.email,
            rowpassword: r.rowpassword ? r.rowpassword.replace(/^orange1234\./, '') : 'Abc1234.',
            name: r.name,
            kana: r.kana,
            phone: r.phone ? String(r.phone) : generateRandomPhone(),
            birthday: String(r.birthday || ''),
            postal: String(r.postal || ''),
            myAddress1: r.myAddress1,
            myAddress2: r.myAddress2,
            gender: r.gender && r.gender.includes('どちらも') ? '9' : '1',
            nickname: generateRandomString(5),
            addressFull: r.myAddress1 ? addressChange(r.myAddress1) + ' ' + r.myAddress2 : r.myAddress2
          }));
          resolve(data);
        };
        reader.readAsBinaryString(file);
      });
    }

    document.getElementById('xlsxInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        globalUserData = await parseXLSX(file);
        document.getElementById('status').textContent = '✅ 已解析 ' + globalUserData.length + ' 条 user 数据';
        window.userData = globalUserData;
      } catch(err) {
        document.getElementById('status').textContent = '❌ 解析失败，请检查格式';
      }
    });

    document.getElementById('generateBtn').addEventListener('click', async () => {
      if (!Array.isArray(globalUserData) || globalUserData.length === 0) {
        alert('⚠️ 请先上传有效的 Excel 文件');
        return;
      }
      const resp = await fetch('./demo.js');
      let jsText = await resp.text();
      jsText = jsText.replace(/const userData = \[[\s\S]*?];/, 'const userData = ' + JSON.stringify(globalUserData, null, 4) + ';');

      const blob = new Blob([jsText], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'demo.js';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>